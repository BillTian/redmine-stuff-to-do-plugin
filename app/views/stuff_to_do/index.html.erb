<h1><%= l(:stuff_to_do_title) %></h1>

<div class="flash error" style="display:none">

</div>

<div class="menu">
  <% if User.current.admin? %>
  <div class="user">
    <% form_tag({ :controller => 'stuff_to_do', :action => 'index'}, :method => :get, :id => 'user_switch' ) do  %>
    <label for="user_id"><%= l(:stuff_to_do_label_view_user_list) %></label>
    <%= collection_select(:user, :id, @users.sort, :id, :name, { }, { :name => 'user_id'}) %>
    <% end %>
  </div>

  <div class="filter">
    <% form_tag({}, :id => 'filter_form') do %>
    <label for="filter"><%= l(:stuff_to_do_label_filter) %></label>
    <%= select_tag("filter", filter_options(@filters, params[:filter])) %>
    <% end %>
  </div>
  <% end %>
</div>
<div style="clear:right;"></div>

<%= render :partial => 'panes' %>

<% content_for :header_tags do %>
  <%= stylesheet_link_tag "stuff_to_do.css", :plugin => "stuff_to_do_plugin", :media => 'all' %>
  <%= javascript_include_tag 'jquery-1.2.6.min.js', :plugin => 'stuff_to_do_plugin' %>
  <%= javascript_include_tag 'ui/ui.core.js', :plugin => 'stuff_to_do_plugin' %>
  <%= javascript_include_tag 'ui/ui.sortable.js', :plugin => 'stuff_to_do_plugin' %>
  <%= javascript_tag("jQuery.noConflict();") %>
  <%= javascript_include_tag 'stuff-to-do.js', :plugin => 'stuff_to_do_plugin' %>
  <%= javascript_tag("var user_id = #{@user.id};") %>

<%# TODO: Move to js file after dev %>
<%# TODO: JSUnit test this %>
<script type="text/javascript">
jQuery(document).ready(function(){
    attachSortables();

    jQuery("#user_id").change(function() {  jQuery("form#user_switch").submit();  });
    jQuery("#ajax-indicator").ajaxStart(function(){ jQuery(this).show();  });
    jQuery("#ajax-indicator").ajaxStop(function(){ jQuery(this).hide();  });

    jQuery("#filter").change(function() {
        jQuery.ajax({
            type: "GET",
            url: '/stuff_to_do/available_issues.js',
            data: jQuery('#filter').serialize(),
            success: function(response) {
                jQuery('#available-pane').html(response);
                attachSortables();
            },
            error: function(response) {
                jQuery("div.error").html("Error filtering pane.  Please refresh the page.").show();
            }});
    });

});

function attachSortables() {
    jQuery("#available").sortable({ 
        connectWith: ["#doing-now", "#recommended"], 
        placeholder: 'drop-accepted',
        dropOnEmpty: true,
        update : function (event, ui) {
            if (jQuery('#available li.issue').length > 0) {
                jQuery("#available li.empty-list").hide();
            } else {
                jQuery("#available li.empty-list").show();
            }
        }
    }); 

    jQuery("#doing-now").sortable({ 
        connectWith: ["#available", "#recommended"], 
        dropOnEmpty: true,
        placeholder: 'drop-accepted',
        update : function (event, ui) { saveOrder(ui); }
    });  

    jQuery("#recommended").sortable({ 
        connectWith: ["#available", "#doing-now"],
        dropOnEmpty: true,
        placeholder: 'drop-accepted',
        update : function (event, ui) { saveOrder(ui); }
    });  

}

function saveOrder() {
    data = 'user_id=' + user_id + '&' + jQuery("#doing-now").sortable('serialize') + '&' + jQuery("#recommended").sortable('serialize');
    if (filter != null) {
        data = data + '&filter=' + filter;
    }
    jQuery.ajax({
        type: "POST",
        url: '/stuff_to_do/reorder.js',
        data: data,
        success: function(response) {
            jQuery('#panes').html(response);
            attachSortables();
        },
        error: function(response) {
            jQuery("div.error").html("Error saving lists.  Please refresh the page and try again.").show();
        }});

}
</script>
<% end %>
